<!doctype html>
<html lang="de">

  <head>
    <title>Simulation</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!--<script type="text/javascript" src="../MathJax/MathJax.js?config=TeX-AMS_HTML"></script>-->
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>

    <header>
      <h1>Simulation</h1>
    </header>

    <main>
      <h2>PT2 - FMU</h2>
      <p ID="formel">
        \begin{equation}
        \ddot{x} = \frac{1}{c_2} (k-c_1\dot{x}-x)
        \end{equation}
      </p>
      <div id="parameterTable"></div>
      <button type='button' onclick="simulate()">Simulate</button>
      <div id="sim"></div>
      <p>
        <a href=".">Neu</a>
        <a href="/simulation/data">Daten</a>
        <a href="model_parameter.html">Model Paramter</a>
        <a href="/simulation/fmu/modelDescription.xml">ModelDescription</a>
      </p>
    </main>

    <footer>
      <p>FH 2017</p>
    </footer>

    <script>
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
              myFunction(this);
          }
      };
      xhttp.open("GET", "/simulation/fmu/modelDescription.xml", true);
      xhttp.send();

      function myFunction(xml) {
        var x, xmlDoc;
        var txt = "<table id='variationParameter'>";
        txt+="<tr>";
        txt+="<td><label for='projektname'>Projektname</label></td>"
        txt+="<td><input id='projektname' type='text' name='projektname' value='proj1'/></td>"
        txt+="</tr>";
        xmlDoc = xml.responseXML;
        x = xmlDoc.getElementsByTagName("ScalarVariable");
        for (i=0;i<x.length;i++)
        {
          var name = x[i].attributes.getNamedItem("name").nodeValue;
          var valueReference = x[i].attributes.getNamedItem("valueReference").nodeValue;
          var causality = x[i].attributes.getNamedItem("causality").nodeValue;
          if (causality=="parameter")
          {
            var value = x[i].childNodes[1].attributes[0].nodeValue;
            txt+="<tr>";
            txt+="<td><label for='" + name + "'>" + name + "</label></td>";
            txt+="<td><input id='param" + i + "' type='text' name='" + name + "" + "' valueReference='" + valueReference + "' value='" + value + "'/></td>";
            txt+="</tr>";
          }
        }
        txt+="</table>";
        document.getElementById("parameterTable").innerHTML = txt;
      }
      function simulate()
      {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            document.getElementById("sim").innerHTML = this.responseText;
            plot();
          }
        };

        var parameterlist = "";
        var variationParameter = document.getElementById("variationParameter");
        var parameter = variationParameter.getElementsByTagName("input");
        j=0;
        for (i=0;i<parameter.length;i++)
        {
          if(parameter[i].getAttribute("id")=="projektname")
          {
            if(i>0) parameterlist+="&";
            parameterlist+="projname=";
            parameterlist+=parameter[i].value;
          }
          else
          {
            if(i>0) parameterlist+="&";
            parameterlist+="pname"+j+"=";
            parameterlist+=parameter[i].getAttribute("name");
            parameterlist+="&";
            parameterlist+="pref"+j+"=";
            parameterlist+=parameter[i].getAttribute("valueReference");
            parameterlist+="&";
            parameterlist+="pval"+j+"=";
            parameterlist+=parameter[i].value;
            j++;
          }
        }

        xhttp.open("POST", "sim.php", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send(parameterlist);
      }

      function plot()
      {
        var name = document.getElementById("projektname").value;
        makeplot("/simulation/data/"+name+".txt");
      }

      function makeplot(resultFile) {
        Plotly.d3.csv(resultFile, function(data){ processData(data) } );
      }

      function processData(allRows) {
        var x = [], y = [];
        for (var i=0; i<allRows.length; i++) {
            row = allRows[i];
            x.push( row['time'] );
            y.push( row['value'] );
        }
        makePlotly( x, y);
      }

      function makePlotly( x, y){
        var name = document.getElementById("projektname").value;
        var traces = [{
          x: x,
          y: y,
          mode: 'lines',marker: {color: 'rgb(219, 64, 82)',size : 12}
        }];
        var layout = {
		      height: 500,
          title: name,
		      xaxis: {title: 'Time [s]'},
          yaxis: {title: 'Value'}
        };
        Plotly.newPlot('plot', traces,layout);
      }
    </script>
  </body>

</html>
